# .github/workflows/notification-cron.yml
name: Notification System Cron Jobs

on:
  schedule:
    # Processar queue a cada 5 minutos
    - cron: '*/5 * * * *'
    # Enviar digest às 9h BRT (12h UTC)
    - cron: '0 12 * * *'
    # Cleanup domingo às 3h BRT (6h UTC)
    - cron: '0 6 * * 0'

jobs:
  process-queue:
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/5 * * * *'
    steps:
      - name: Process Notification Queue
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/process-queue"

  send-digest:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 12 * * *'
    steps:
      - name: Send Daily Digest
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/send-digest"

  cleanup:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * 0'
    steps:
      - name: Cleanup Old Notifications
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/cleanup-notifications"
